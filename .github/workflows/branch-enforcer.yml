name: Branch Validation

on:
  pull_request:
    branches: [master, develop]

permissions:
  contents: read
  statuses: write
  pull-requests: read

jobs:
  check-source-branch-master:
    if: github.base_ref == 'master'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate PR source branch for master
        run: |
          set -euo pipefail
          HEAD="${{ github.head_ref }}"
          
          if [[ "$HEAD" != "develop" && ! "$HEAD" =~ ^hotfix/ ]]; then
            echo "::error::Only PRs from 'develop' or 'hotfix/*' branches can be merged into 'master'"
            echo "Your branch: $HEAD"
            echo "Allowed branches:"
            echo "  - develop"
            echo "  - hotfix/*"
            exit 1
          fi
          
          echo "::notice::✓ Branch '$HEAD' is allowed to merge into master"

  check-source-branch-develop:
    if: github.base_ref == 'develop'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate PR source branch for develop
        run: |
          set -euo pipefail
          HEAD="${{ github.head_ref }}"
          
          # Permite PRs vindos da master (back-merge) OU dos tipos válidos
          if [[ "$HEAD" == "master" ]]; then
            echo "::notice::✓ Back-merge: 'master' -> 'develop' permitido"
            exit 0
          fi

          if [[ ! "$HEAD" =~ ^(feat|feature|fix|chore|refactor|style|ci|test|docs|hotfix)/ ]]; then
            echo "::error::Invalid branch type for 'develop'"
            echo "Your branch: $HEAD"
            echo "Allowed branch types:"
            echo "  - master (back-merge)"
            echo "  - feat/*"
            echo "  - feature/*"
            echo "  - fix/*"
            echo "  - chore/*"
            echo "  - refactor/*"
            echo "  - style/*"
            echo "  - ci/*"
            echo "  - test/*"
            echo "  - docs/*"
            echo "  - hotfix/*"
            exit 1
          fi
          
          echo "::notice::✓ Branch '$HEAD' follows naming conventions"
          fi
          echo "✓ Branch '$HEAD' is allowed to merge into develop"
