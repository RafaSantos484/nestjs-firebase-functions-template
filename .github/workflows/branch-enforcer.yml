name: Branch Validation

on:
  pull_request:

permissions:
  contents: read
  statuses: write
  pull-requests: read

jobs:
  check-source-branch-default:
    if: github.base_ref == github.event.repository.default_branch
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate PR source branch for default branch
        run: |
          set -euo pipefail
          HEAD="${{ github.head_ref }}"
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          
          if [[ "$HEAD" != "develop" && ! "$HEAD" =~ ^hotfix/ ]]; then
            echo "::error::Only PRs from 'develop' or 'hotfix/*' branches can be merged into the default branch"
            echo "Your branch: $HEAD"
            echo "Allowed branches:"
            echo "  - develop"
            echo "  - hotfix/*"
            exit 1
          fi
          
          echo "::notice::✓ Branch '$HEAD' is allowed to merge into $DEFAULT_BRANCH"

  check-source-branch-develop:
    if: github.base_ref == 'develop'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Validate PR source branch for develop
        run: |
          set -euo pipefail
          HEAD="${{ github.head_ref }}"
          
          # Allow back-merge from the default branch or valid branch types.
          DEFAULT_BRANCH="${{ github.event.repository.default_branch }}"
          if [[ "$HEAD" == "$DEFAULT_BRANCH" ]]; then
            echo "::notice::✓ Back-merge: '$DEFAULT_BRANCH' -> 'develop' allowed"
            exit 0
          fi

          if [[ ! "$HEAD" =~ ^(feat|feature|fix|chore|refactor|style|ci|test|docs|hotfix)/ ]]; then
            echo "::error::Invalid branch type for 'develop'"
            echo "Your branch: $HEAD"
            echo "Allowed branch types:"
            echo "  - $DEFAULT_BRANCH (back-merge)"
            echo "  - feat/*"
            echo "  - feature/*"
            echo "  - fix/*"
            echo "  - chore/*"
            echo "  - refactor/*"
            echo "  - style/*"
            echo "  - ci/*"
            echo "  - test/*"
            echo "  - docs/*"
            echo "  - hotfix/*"
            exit 1
          fi
          
          echo "::notice::✓ Branch '$HEAD' follows naming conventions"
